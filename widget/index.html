<!DOCTYPE html>
<html>
  <head>
    <title>World Loanmeter</title>
    <link rel="stylesheet" type="text/css" href="style/kivaness.css">
    <script type="text/javascript" src="javascript/jquery.js"></script>
    <!-- Data for development. See dataSource, below -->
    <!-- script type="text/javascript" src="javascript/debugdata.js"></script -->
    <script type="text/javascript" src="javascript/kivadata.js"></script>
    <script type="text/javascript" src="javascript/map.js"></script>
    <script type="text/javascript" src="javascript/kivamap.js"></script>
    <script type="text/javascript" src="javascript/jquery.flot.pack.js"></script>

    <script type="text/javascript">
      var data         = new KivaData();
      // Uncomment for development. See above for the debugging data
      // data.dataSource  = page1;
      var map          = new KivaMap('#main-map', '#map-css', data);
      data.numberLoans = widget.preferenceForKey('numberLoans') || 20;

      $(document).ready(function(ev) {
        $('#spinner').show('fast');
        data.refresh(function () {
          map.placeLoans();
          $('#spinner').hide('fast');
          // Add sector list to the info panel
          map.showSectorDirectoryInPanel();
        });

        $('#flipbutton').click(function () {
          flip();
        });

        $('#closebutton').click(function () {
          window.close();
        });

        $('#numberloans').val(data.numberLoans);

        $('#updatebutton').click(function () {
          data.numberLoans = $('#numberloans').val();
          widget.setPreferenceForKey(data.numberLoans, 'numberLoans');
          $('#spinner').show('fast');
          data.refresh(function () {
            map.refresh();
            $('#spinner').hide('fast');
            flip();
          });
        });
      });

      // Changes back and forth between the main view and the config view
      function flip ()
      {
        var display = $('#front').css('display');
        if (display == 'block' || display == '') {
            $('#front').css('display', "none");
            $('#config').css('display', "block");
        } else {
            $('#config').css('display', "none");
            $('#front').css('display', "block");
        }
      }
    </script>
    <style type="text/css" id="map-css"></style>
  </head>
  <body>
    <div id="container">
      <div id="header">
        <div id="controlbuttons">
          <img id="spinner" width="32" height="32" src="images/spinner.gif"/>
          <button id="flipbutton" class="controlbutton" type="button"></button>
          <button id="closebutton" class="controlbutton" type="button"></button>
        </div>
        <h1>World Loanmeter</h1>
      </div>
      <div id="content">
        <div id="front">
          <div id="main-map" class="map"></div>
          <div id="stats-container">
            <div id="stats"></div>
          </div>
          <div id="info-panel"><div class="notice">Loading loan information
              from Kiva...</div></div>
        </div>
        <div id="config">
          <h2>Configuration</h2>

          <div style="padding-bottom: 10px">
            <div>
              Number of loans to show:
              <input type="text" id="numberloans" name="numberloans" size="3" maxlength="3" value="" />
            </div>
            <button id="updatebutton" type="button">Update</button>
          </div>
        </div>
      </div>
      <div id="footer">Powered by Opera Widgets, jQuery and <a href="http://build.kiva.org/">Kiva API</a></div>
    </div>
  </body>
</html>
