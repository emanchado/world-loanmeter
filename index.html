<!DOCTYPE html>
<html>
  <head>
    <title>World Kivaness viewer</title>
    <link rel="stylesheet" type="text/css" href="style/kivaness.css">
    <script type="text/javascript" src="javascript/kivadata.js"></script>
    <script type="text/javascript" src="javascript/jquery.js"></script>
    <script type="text/javascript" src="javascript/map.js"></script>

    <script type="text/javascript">
      var data         = new kivaData();
      var loansInPlace = {};

      $(document).ready(function(ev) {
        var counter = 0;
        jQuery.each(data.loanInfo.loans, function () {
          counter++;
          var loan = this;

          // Collect all the loans in each place, and put only one dot in the
          // map for each place
          var placeId = 'location' +
                          loan.location.geo.pairs.replace(/[^0-9]/g, '-');
          if (loansInPlace[placeId] == undefined) { // First loan
            loansInPlace[placeId] = [];
            [lat, lon] = loan.location.geo.pairs.split(' ');
            mapMaker.placeIdByLatitudeAndLongitude('a#'+placeId,
                                                   parseFloat(lat),
                                                   parseFloat(lon));
            htmlString = data.loanInfoWithTemplate(loan,
              '<a class="location" href="#" onmouseover="showInfoInPanel(\'' + placeId + '\'); return false;" id="' + placeId + '">click here</a>');
          }

          var extraClass = (loansInPlace[placeId].length % 2 == 0) ? 'odd' :
                                                                     'even';
          loansInPlace[placeId].push(data.loanInfoWithTemplate(loan,
            '<div class="loan-info ' + extraClass +
              '"><img src="LOANSMALLIMGURL" width="80" height="80" ' +
              'alt="LOANTOWN, LOANCOUNTRY" />' +
              '<div class="loan-title"><a href="LOANLINK">BORROWERNAME</a></div>' +
              '<div class="loanuse">LOANUSE</div>' +
              '<div class="loanstatus">LOANSTATUS</div>' +
              '<div class="loansectoractivity">LOANSECTOR - LOANACTIVITY</div>' +
              '</div>'));

          $('#main-map').prepend(htmlString);
        });
      });

      function showInfoInPanel (locationId) {
        $('#info-panel').html(loansInPlace[locationId].join(''));
      }
    </script>
  </head>
  <body>
    <div id="container">
      <div id="header">
        <div id="controlbuttons">
          <button id="flipbutton" class="controlbutton" type="button"></button>
          <button id="closebutton" class="controlbutton" type="button"></button>
        </div>
        <h1>World Kivaness</h1>
      </div>
      <div id="content">
<dl id="main-map" class="map">
</dl>
      </div>
      <div id="info-panel"><div class="loan-info instructions">Hover an area to get information about loans</div></div>
      <div id="footer">Powered by Opera Widgets, jQuery and <a href="http://build.kiva.org/">Kiva API</a></div>
    </div>
  </body>
</html>
